<style type="text/css">
  .chat-content{

  }
  .chat-content-div-sec{
    overflow-y: scroll;
  }
  .chat-setting-div-sec{
  }
  .user-to-user-con-tol{
    position: fixed;
    bottom: 60px;
  }
  .chat-setting-div-tool{
    margin-top: 7px;
    font-size: 25px;
    cursor: pointer;
  }
  .chat-type-box{
    margin-left: 2%;
    width: 90%;
    height: 40px;
  }
  .direct-chat-msg{
      margin-top: 4%;
  }
  .direct-chat-message{
    margin-left: 2%;
    margin-right: 2%;
    margin-top: 2%;
  }
  .right-chat-user{
    margin-left: 70% !important;
  }
  .right-chat-user-info{
    margin-left: 90% !important;
  }
  .back-to-chat-list{
    cursor: pointer;
    color: black;
  }
  .chat-setting-button{
    display: none;
  }
  .msg-send-submit-img{
    margin-top: -5px;
  }
  .chatimg-position-lg{
    margin-left: 89%;
  }
  .chatAudio-position-lg{
    margin-left: 75%;
  }
  .chatVideo-position-lg{
    margin-left: 82%;
  }
  ::-webkit-input-placeholder {
    color: green;
  }
  .chatimg-div{
    display: none;
    position: absolute;
    left: 10%;
    bottom: 1.5%;
  }
  .chat-file-class{
    display: none;
    position: absolute;
    left: 5%;
    bottom: 9%;
    width: 150px;
    height: 150px;
    border-radius: 20px;
  }
  .chat-file-div{
    margin-left: 6px;
    margin-top: 10px;
  }
  .chat-file-option{
    width: 60px;
    height: 60px;
    margin-left: 5px;
    margin-top: 5px;
    border-radius: 50%;
    text-align: center;
    float: left;
  }
  .chat-file-option span{
    margin-top: 16px;
    font-size: 25px;
  }
  #chat-camera-snap-div{
    display: none;
    width: 100%;
    height: 100%;
  }
  #chat-file-link-camera{
    margin-left: 10%;
    width: 80%;
    height: 80%;
  }
  .close-snap-div{ 
    margin-top: -3px;
    font-size: 18px;
    color: black;
  }
  .close-snap-div-next{
    display: none;
    font-size: 12px;
    color: black;
  }
  .btn-circle{
    border-radius: 50%;
  }
  .pull-center{
    margin-left: 45%;
  }
  #take-snap-image{
    font-size: 25px;
    color: white;
    font-weight: bold;
  }
  #take-snap-image-chat{
    display: none;
    font-size: 25px;
    color: white;
    font-weight: bold;
  }
  #resultts{
    margin-left: 10%;
    width: 80%;
    height: 80%;
    color: black;
    font-weight: bold;
  }
  #canvas{
    display: none;
  }
  #chat-camera-snap-div .box{
    margin-top: 2%;
    margin-left: 30%;
    width: 40%;
    height: 80%;
  }
  #back-camera-open, #back-camera-open1{
      display: none;
  }
  .direct-chat-text{
      background: ;
      font-size: 16px;
      width: auto !important;
      max-width: 50% !important;
      word-break: break-word;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: auto;
      -webkit-box-orient: vertical;
      border-radius: 20px;
      background: #D1D2D3;
  }
  .msgujsgvdf{
  }
  .chat-content-div{
      background: ;
  }
  .direct-chat-infos{
      margin-left: 5%;
  }
  .direct-chat-name{
      color: #808080;
      font-size: 10px;
      display: none;
  }
  .direct-chat-timestamp{
      font-size: 10px;
      display: ;
  }
  @media only screen and (max-width: 768px) {
    .direct-chat-msg{
      margin-top: 4%;
    }
    .chat-content-div-footer{
        position: fixed;
        bottom: 0px;
        width: 100%;
    }
    .chat-content-div{
        position: ;
        bottom: 60px;
        width: 100%;
    }
    .chatdataupleft{
    }
    .chat-content-div-sec{
      height: 543px;
    }
    .chat-type-box{
      margin-left: 3%;
      width: 75%;
      height: 40px;
      border-radius: 20px;
      border: 1px solid #eee;
      background: #eee;
    }
    .chat-type-box:hover{
        outline: none;
    }
    .direct-chat-infos{
      margin-left: 15%;
    }
    .right-chat-user{
      margin-left: 46% !important;
      width: auto !important;
      width: 50% !important;
    }
    .right-chat-user-info{
      margin-left: 68% !important;
    }
    .chat-setting-button{
      display: block;
      margin-right: 2px;
      font-size: 20px;
    }
    .chatimg-position-lg{
      margin-left: 67%;
    }
    .chatAudio-position-lg{
      margin-left: 15%;
    }
    .chatVideo-position-lg{
      margin-left: 43%;
    }
    .back-to-chat-list{
      font-weight: bold;
    }
    #chat-camera-snap-div .box{
      margin-left: 0%;
      width: 100%;
      height: 80%;
    }
    #chat-file-link-camera{
      margin-left: 0%;
      margin-top: -38px !important;
      width: 100%;
    }
    #resultts{
      margin-left: 0px !important;
      width: 100%;
      height: 80%;
    }
    #take-snap-image, #take-snap-image-chat{
        margin-left: 15%;
    }
    #back-camera-open{
        display: block;
        float: left;
        margin-left: 17%;
        margin-top: 4%;
    }
    #back-camera-open1{
        float: left;
        margin-left: 17%;
        margin-top: 4%;
    }
    .chat-file-class{
       bottom: 5% !important;
    }
    .image-c-big-s{
        position: fixed;
        top: 8%;
        left: 4%;
        width: 92%;
        height: 78%;
        border: 1px solid green;
        border-radius: 20px;
        background: white;
        display: none;
    }
    .image-c-big-s img{
        margin-left: 5%;
        position: relative;
        margin-top: 20%;
        width: 90%;
    }
    .image-c-big-s .image-c-close{
        position: fixed;
        top: 11%;
        right: 15%;
        background: #A42C09;
        color: white;
    }
  }
  
</style>
<?php
include '../lib/Database.php';
$db = new Database();
date_default_timezone_set("Asia/Dhaka");
$dt = new DateTime('now');
$dt = $dt->format('dmyhi');

if($_REQUEST['chattouser']){
    $chattouser = $_REQUEST['chattouser'];
?>
    <div class="box-body no-padding chat-content-div">
      <div class="user-to-user-con chat-content-div-sec" id="chat-content-div-sec">
        <div class="direct-chat-message chat-content-div-sec-chat">
        <!-- main Chat -->
        </div>
      </div>
    </div>
    <div class="box-footer chat-content-div-footer">
      <div class="box-tools">
        <form id="chat-form" action="javascript:void(0);">
          <span class="pull-left">
            <i class="fa fa-plus-circle chat-setting-div-tool chat-file-linkk"></i>
          </span>
          <input type="file" name="image" class="chatImageLink camLink" accept="image/*" capture onchange="previewFilecam()" style="display: none;">
          <input type="file" name="image" class="chatImageLink imgLink" accept="image/*" onchange="previewFileimg()" style="display: none;">
          <input type="file" name="audio" class="chatImageLink audioLink" accept="audio/*" onchange="previewFileaudio()" style="display: none;">
          <input type="file" name="video" class="chatImageLink videoLink" accept="video/*" onchange="previewFilevideo()" style="display: none;">
          <input type="text" class="chatImageLinkCapture" style="display: none;">
          <div class="chatimg-div">
            <img src="" id="chatimg" width="50">
          </div>
          <input type="hidden" name="chattouser" value="<?php echo $chattouser; ?>">
          <input type="text" class="chat-type-box" placeholder="Type a message.." />
          <span class="pull-right msg-send-submit">
            <img src="img/send.png" width="50" class="msg-send-submit-img">
          </span>
        </form>
      </div>
    </div>
    <div class="chat-file-class">
      <div class="chat-file-div">
        <div class="chat-file-option chat-file-link-camera chat-file-link" id="camLink">
          <span class="fa fa-camera"></span>
        </div>
        <div class="chat-file-option chat-file-link-image chat-file-link" id="imgLink">
          <span class="fa fa-image"></span>
        </div>
        <div class="chat-file-option chat-file-link-audio chat-file-link" id="audioLink">
          <span class="fa fa-volume-up"></span>
        </div>
        <div class="chat-file-option chat-file-link-video chat-file-link-cameraa" id="videoLink">
          <span class="fa fa-video-camera"></span>
        </div>
      </div>
    </div>
    <div id="chat-camera-snap-div" class="modal">
      <div class="box">
        <div class="box-header">
          <span class="close-snap-div btn btn-default btn pull-right">X</span>
          <span class="close-snap-div-next btn btn-default pull-right">Again</span>
        </div>
        <div class="box-body">
          <div id="resultts">
            <img id="photo">
          </div>
          <video autoplay="true" id="chat-file-link-camera"></video>
          <canvas id="canvas" width="340" height="450"></canvas>
        </div>
        <div class="box-footer">
          <span id="back-camera-open" class="btn btn-success btn-circle"><i class="fa fa-refresh"></i></span>
          <span id="back-camera-open1" class="btn btn-success btn-circle"><i class="fa fa-refresh"></i></span>
          <span id="take-snap-image-chat" class="btn btn-success btn-lg btn-circle pull-center"><i class="fa fa-check"></i></span>
          <span id="take-snap-image" class="btn btn-success btn-lg btn-circle pull-center"><i class="fa fa-camera"></i></span>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      function openCamera(){
        var video = document.querySelector("#chat-file-link-camera");
        if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ video: true })
          .then(function (stream) {
            video.srcObject = stream;
          })
          .catch(function (err0r) {
            alert("Try later!");
          });
        }
      }
      function closeCamera(){
        var video = document.querySelector("#chat-file-link-camera");
        function stopStreamedVideo(videoElem) {
          const stream = videoElem.srcObject;
          const tracks = stream.getTracks();
          tracks.forEach(function(track) {
            track.stop();
          });
          videoElem.srcObject = null;
        }
        stopStreamedVideo(video);
      }
      function backCamera(){
        var video = document.querySelector("#chat-file-link-camera");
        if (navigator.mediaDevices.getUserMedia) {
            alert("Try later!vyuv");
          navigator.mediaDevices.getUserMedia(constraints).then(stream => {
            currentStream = stream;
            video.srcObject = stream;
            return navigator.mediaDevices.enumerateDevices();
          })
          .catch(function (err0r) {
            alert("Try later!!");
          });
        }else{
          alert("Try later!");  
        }
      }
      $(document).on('click', '.chat-file-link-cameraatfyt', function(){
        $('.chat-file-class').hide();
        $('#chat-camera-snap-div').show();
        openCamera();
      });
      $(document).on('click', '#back-camera-open', function(){
        $('.chat-file-class').hide();
        $('#chat-camera-snap-div').show();
        $(this).hide();
        $('#back-camera-open1').show();
        closeCamera();
        backCamera();
      });
      $(document).on('click', '#back-camera-open1', function(){
        $('.chat-file-class').hide();
        $('#chat-camera-snap-div').show();
        $(this).hide();
        $('#back-camera-open').show();
        openCamera();
      });
      $(document).on('click', '.close-snap-div', function(){
        $('#chat-camera-snap-div').hide();
        $('#photo').attr('src','');
        $('#take-snap-image').show();
        $('#take-snap-image-chat').hide();
        closeCamera();
      });
      $(document).on('click', '.close-snap-div-next', function(){
        $('#photo').attr('src','');
        $('#take-snap-image').show();
        $('#take-snap-image-chat').hide();
        $('.close-snap-div').show();
        $('.close-snap-div-next').hide();
        $('#chat-file-link-camera').show();
        openCamera();
      });
      $(document).on('click', '#take-snap-image', function(){
        $('#take-snap-image').hide();
        $('#take-snap-image-chat').show();
        $('.close-snap-div').hide();
        $('.close-snap-div-next').show();
        $('#chat-file-link-camera').hide();
        var video = document.getElementById('chat-file-link-camera');
        var canvas = document.getElementById('canvas');
        var photo = document.getElementById('photo');
        var context = canvas.getContext('2d');

        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        var data = canvas.toDataURL('image/png');
        photo.setAttribute('src', data);
        closeCamera();
      });
      $(document).on('click', '#take-snap-image-chat', function(){
        $('#take-snap-image').hide();
        $(this).hide();
        $('.close-snap-div').hide();
        $('.close-snap-div-next').hide();
        $('#chat-camera-snap-div').hide();
        $('#chat-file-link-camera').hide();
        var capturePhoto = $('#photo').attr('src');
        $('#photo').attr('src','');
        var capturePhotoName = "<?php echo $_COOKIE["userId"].$dt; ?>"+".png";
        $('.chatImageLinkCapture').val(capturePhotoName);
        $('.chat-type-box').hide();
        $('.chatimg-div').show();
        $('#chatimg').attr('src',capturePhoto);
      });
      $(document).on('click', '.chat-file-linkk', function(){
        $(".chat-file-class").slideToggle();
      });
      $(document).on('click', '#camLink', function(){
        $(".camLink").trigger('click');
        $('.chat-file-class').hide();
        $('.imgLink').setAttribute('disabled');
        $('.audioLink').setAttribute('disabled');
        $('.videoLink').setAttribute('disabled');
      });
      $(document).on('click', '#imgLink', function(){
        $(".imgLink").trigger('click');
        $('.chat-file-class').hide();
        $('.camLink').setAttribute('disabled');
        $('.audioLink').setAttribute('disabled');
        $('.videoLink').setAttribute('disabled');
      });
      $(document).on('click', '#audioLink', function(){
        $(".audioLink").trigger('click');
        $('.chat-file-class').hide();
        $('.imgLink').setAttribute('disabled');
        $('.camLink').setAttribute('disabled');
        $('.videoLink').setAttribute('disabled');
      });
      $(document).on('click', '#videoLink', function(){
        $(".videoLink").trigger('click');
        $('.chat-file-class').hide();
        $('.imgLink').setAttribute('disabled');
        $('.audioLink').setAttribute('disabled');
        $('.camLink').setAttribute('disabled');
      });
      function previewFilecam() {
        var extension = $('.camLink').val().split('.').pop().toLowerCase();
        if(extension =='gif' || extension =='png' || extension =='jpg' || extension =='jpeg'){
          $('.chat-type-box').hide();
          $('.chatimg-div').show();
          var preview = document.getElementById('chatimg');
          var file    = document.querySelector('.camLink').files[0];
          var reader  = new FileReader();
          reader.onloadend = function () {
            preview.src = reader.result;
          }
          if (file) {
            reader.readAsDataURL(file);
          } else {
            preview.src = "";
          }
        }else{
          var path = $('.camLink').val();
          var filename = path.replace(/C:\\fakepath\\/, '');
          $('.chat-type-box').val(filename);
        }
        
      }
      function previewFileimg() {
        var extension = $('.imgLink').val().split('.').pop().toLowerCase();
        if(extension =='gif' || extension =='png' || extension =='jpg' || extension =='jpeg'){
          $('.chat-type-box').hide();
          $('.chatimg-div').show();
          var preview = document.getElementById('chatimg');
          var file    = document.querySelector('.imgLink').files[0];
          var reader  = new FileReader();
          reader.onloadend = function () {
            preview.src = reader.result;
          }
          if (file) {
            reader.readAsDataURL(file);
          } else {
            preview.src = "";
          }
        }else{
          var path = $('.imgLink').val();
          var filename = path.replace(/C:\\fakepath\\/, '');
          $('.chat-type-box').val(filename);
        }
        
      }
      function previewFilevideo() {
        var extension = $('.videoLink').val().split('.').pop().toLowerCase();
        if(extension =='gif' || extension =='png' || extension =='jpg' || extension =='jpeg'){
          
        }else{
          $('.chatimg-div').hide();
          $('.chat-type-box').show();
          var path = $('.videoLink').val();
          var filename = path.replace(/C:\\fakepath\\/, '');
          $('.chat-type-box').val(filename);
        }
        
      }
      function previewFileaudio() {
        var extension = $('.audioLink').val().split('.').pop().toLowerCase();
        if(extension =='gif' || extension =='png' || extension =='jpg' || extension =='jpeg'){
          
        }else{
          $('.chatimg-div').hide();
          $('.chat-type-box').show();
          var path = $('.audioLink').val();
          var filename = path.replace(/C:\\fakepath\\/, '');
          $('.chat-type-box').val(filename);
        }
        
      }
      $(document).ready(function(){
        $('.cateryNameShow').show();
        var chattouser = "<?php echo $chattouser; ?>";
        $('.cateryNameShow').text(chattouser);
        $('.chat-content-div-sec-chat').load('chatboxchat.php',{chattouser:chattouser});

        window.setTimeout(function() {
          var elem = document.getElementById('chat-content-div-sec');
          elem.scrollTop = elem.scrollHeight;
        }, 500);
        var seenchat = 0;
        $.ajax({
            method: 'POST',
            url: 'seenchat.php',
            data: {
                seenchat: seenchat,
                chattouser: chattouser
            },
            success:function(data){
            }
        });
      });
      $('#chat-content-div-sec').on('scroll', function() {
          var scrollTop = $(this).scrollTop();
          var messagechatLastId = $('.messagechatLastId').val();
          var chattouser = "<?php echo $chattouser; ?>";
          if (scrollTop <= 0 && messagechatLastId > 0) {
            $.ajax({
              method: 'POST',
              url: 'chatboxchatScroll.php',
              data: {
                messagechatLastId: messagechatLastId,
                chattouser: chattouser
              },
              success:function(data){
                $('.chat-content-div-sec-chat').prepend(data);
                var el = document.getElementById('chat-content-div-sec');
                el.scrollTop = 1;
              }
            });
          }
      });
      $(document).on('click', '.msg-send-submit', function(){
        var message = $('.chat-type-box').val();
        var chattouser = "<?php echo $chattouser; ?>";
        var sendMessageSubmit = 0;
        var image = '';
        image = $('.camLink').val();
        if(image == ''){
            image = $('.imgLink').val();
            if(image == ''){
                image = $('.audioLink').val();
                if(image == ''){
                    image = $('.videoLink').val();
                }
            }
        }
        var capturePhotoo = $('.chatImageLinkCapture').val();
        if(capturePhotoo !== ''){
          var capturePhotooLink = $('#chatimg').attr('src');
          $.ajax({
            method: 'POST',
            url: 'sendMessageCapture.php',
            data: {
              capturePhotooLink: capturePhotooLink,
              capturePhotoo: capturePhotoo,
              chattouser: chattouser
            },
            success:function(data){
              if(data == ''){
                $('.chat-content-div-sec-chat').load('chatboxchat.php',{chattouser:chattouser});
                $('.chat-type-box').show();
                $('.chatimg-div').hide();
                $('.camLink').val('');
                window.setTimeout(function() {
                  var elem = document.getElementById('chat-content-div-sec');
                  elem.scrollTop = elem.scrollHeight;
                }, 1000);
              }else{
                alert('Try Later!');
              }
            }
          });
        }
        else if(image == '' && capturePhotoo == ''){
          $.ajax({
            method: 'POST',
            url: 'sendMessage.php',
            data: {
              sendMessageSubmit: sendMessageSubmit,
              chattouser: chattouser,
              message: message
            },
            success:function(data){
              if(data == ''){
                $('.chat-content-div-sec-chat').load('chatboxchat.php',{chattouser:chattouser});
                $('.chat-type-box').val('');
                window.setTimeout(function() {
                  var elem = document.getElementById('chat-content-div-sec');
                  elem.scrollTop = elem.scrollHeight;
                }, 1000);
              }else{
                alert(data);
              }
            }
          });
        }else{
          var extension = '';
          extension = $('.camLink').val().split('.').pop().toLowerCase();
          if(extension == ''){
              extension = $('.imgLink').val().split('.').pop().toLowerCase();
              if(extension == ''){
                  extension = $('.audioLink').val().split('.').pop().toLowerCase();
                  if(extension == ''){
                      extension = $('.videoLink').val().split('.').pop().toLowerCase();
                  }
              } 
          }
          if(extension =='gif' || extension =='png' || extension =='jpg' || extension =='jpeg'){
            var camlink = '';
            var file_data = '';
            camlink = $('.camLink').val();
            if(camlink != ''){
                file_data = $('.camLink').prop("files")[0];
            }else{
                file_data = $('.imgLink').prop("files")[0];
            }
            var form_data = new FormData();
            form_data.append("image", file_data);
            form_data.append("chattouser", chattouser);
            $.ajax({
              method: 'POST',
              url: 'sendMessage.php',
              data: form_data,
              cache: false,
              contentType: false,
              processData: false,
              success:function(data){
                if(data == ''){
                  $('.chat-content-div-sec-chat').load('chatboxchat.php',{chattouser:chattouser});
                  $('.chat-type-box').show();
                  $('.chatimg-div').hide();
                  $('.camLink').val('');
                  $('.imgLink').val('');
                  window.setTimeout(function() {
                    var elem = document.getElementById('chat-content-div-sec');
                    elem.scrollTop = elem.scrollHeight;
                  }, 1000);
                }else{
                  alert(data);
                }
              }
            });
          }else if(extension =='mp3' || extension =='m4a'){
            var file_data = $('.audioLink').prop("files")[0];
            var form_data = new FormData();
            form_data.append("image", file_data);
            form_data.append("chattouser", chattouser);
            $.ajax({
              method: 'POST',
              url: 'sendMessageAudio.php',
              data: form_data,
              cache: false,
              contentType: false,
              processData: false,
              success:function(data){
                if(data == ''){
                  $('.chat-content-div-sec-chat').load('chatboxchat.php',{chattouser:chattouser});
                  $('.chat-type-box').show();
                  $('.chatimg-div').hide();
                  $('.audioLink').val('');
                  window.setTimeout(function() {
                    var elem = document.getElementById('chat-content-div-sec');
                    elem.scrollTop = elem.scrollHeight;
                  }, 1000);
                }else{
                  alert(data);
                }
              }
            });
          }else if(extension =='mp4'){
            var file_data = $('.videoLink').prop("files")[0];
            var form_data = new FormData();
            form_data.append("image", file_data);
            form_data.append("chattouser", chattouser);
            $.ajax({
              method: 'POST',
              url: 'sendMessageVideo.php',
              data: form_data,
              cache: false,
              contentType: false,
              processData: false,
              success:function(data){
                if(data == ''){
                  $('.chat-content-div-sec-chat').load('chatboxchat.php',{chattouser:chattouser});
                  $('.chat-type-box').show();
                  $('.chatimg-div').hide();
                  $('.videoLink').val('');
                  window.setTimeout(function() {
                    var elem = document.getElementById('chat-content-div-sec');
                    elem.scrollTop = elem.scrollHeight;
                  }, 1000);
                }else{
                  alert(data);
                }
              }
            });
          }
        }
        $('.chat-type-box').val('');
      });
      $(document).on('click', '.image-c-big', function(){
        $("#image-c-bigg").show();
          var file = $(this).attr('src');
          $('#imgzfbfhrth').attr('src',file);
        
      });
      $(document).on('click', '.image-c-close', function(){
        $("#image-c-bigg").hide();
      });
  </script>
<?php
}
?>